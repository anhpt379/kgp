#!/bin/bash
# ============================================================================
# kgp - kubectl get pods (and more)
#
# Interactive FZF-based tool for exploring and managing Kubernetes resources
# ============================================================================
set -euo pipefail

# ============================================================================
# Constants
# ============================================================================
readonly SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
readonly CACHE_REFRESH_INTERVAL="${KGP_CACHE_REFRESH:-30}"

# Colors
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[0;33m'
readonly ORANGE='\033[38;5;214m'
readonly CYAN='\033[0;36m'
readonly GRAY='\033[0;90m'
readonly MAGENTA='\033[0;35m'
readonly WHITE='\033[0;37m'
readonly RESET='\033[0m'

# Library paths
readonly LIB_SEARCH_PATHS=(
    "${SCRIPT_DIR}/lib/format-pods.py"
    "${HOME}/.local/lib/kgp/format-pods.py"
    "/usr/local/lib/kgp/format-pods.py")

# ============================================================================
# Global Variables
# ============================================================================
CACHE_BASE_DIR="${KGP_CACHE_DIR:-/tmp/kgp}"
mkdir -p "${CACHE_BASE_DIR}"

CONTEXT=""
NAMESPACE=""
CACHE_DIR=""
STATE_FILE=""
BG_REFRESH_PID=""
LIB_PATH=""
RESOURCE=""
OBJECT=""

# ============================================================================
# Source Libraries
# ============================================================================
source "${SCRIPT_DIR}/lib/core.sh"
source "${SCRIPT_DIR}/lib/k8s.sh"
source "${SCRIPT_DIR}/lib/state.sh"
source "${SCRIPT_DIR}/lib/cache.sh"
source "${SCRIPT_DIR}/lib/display.sh"
source "${SCRIPT_DIR}/lib/actions.sh"

# ============================================================================
# Export Functions for FZF
# ============================================================================
export -f debug colorize highlight_logs load_state save_state
export -f show_pod_header show_container_header show_context_header show_resources_header show_objects_header
export -f list_pods list_containers list_contexts list_resources list_objects
export -f refresh_cache refresh_objects_cache display_data dispatch
export -f exec_shell delete_object describe_object view_logs create_debug_pod
export -f get_contexts switch_context get_current_namespace
export -f scale_object edit_object show_help show_less_help less_help print_stream_closed_eof

# Export variables
export RED GREEN YELLOW ORANGE CYAN GRAY MAGENTA WHITE RESET
export LIB_PATH CACHE_BASE_DIR CACHE_DIR
export STATE_FILE CONTEXT NAMESPACE MODE POD RESOURCE OBJECT

# ============================================================================
# Setup
# ============================================================================
check_dependencies "kubectl" "fzf" "python3" "awk" "curl" "grep" "sed" "less" "mktemp" "sort" "jq"
LIB_PATH=$(find_library)

# Initialize environment
CONTEXT=$(get_current_context) || {
    echo "Failed to get current context" >&2
    exit 1
}
NAMESPACE=$(get_current_namespace)
CACHE_DIR="${CACHE_BASE_DIR}/${CONTEXT}/${NAMESPACE}"
STATE_FILE="${CACHE_BASE_DIR}/.state"

debug "Initialized with CONTEXT=$CONTEXT, NAMESPACE=$NAMESPACE, CACHE_DIR=$CACHE_DIR"

# Initialize state
save_state "pods"

# ============================================================================
# Main UI
# ============================================================================
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    trap cleanup EXIT INT TERM
    start_background_refresh

    display_data | fzf \
        --no-multi \
        --ansi \
        --tiebreak=begin,index \
        --prompt="Pods> " \
        --height=100% \
        --header-lines=3 \
        --listen \
        --preview="show_help" \
        --preview-window=right,40%,hidden \
        --bind="?:toggle-preview" \
        --bind="change:first" \
        --bind='start:execute-silent:echo "FZF_PORT=$FZF_PORT" >> $STATE_FILE' \
        --bind="ctrl-c:abort" \
        --bind="ctrl-n:down" \
        --bind="ctrl-p:up" \
        --bind="ctrl-f:page-down" \
        --bind="ctrl-b:page-up" \
        --bind="f5:execute-silent(refresh_cache)+reload(display_data)" \
        --bind="enter:transform:
            if grep -q MODE=containers \$STATE_FILE; then
                echo 'execute(dispatch logs {1})+reload(display_data)'
            elif grep -q MODE=contexts \$STATE_FILE; then
                echo 'execute(dispatch enter {1})+change-prompt(Pods> )+reload(display_data)+clear-query'
            elif grep -q MODE=resources \$STATE_FILE; then
                echo 'execute(dispatch enter {1})+change-prompt({1}> )+reload(display_data)+clear-query'
            elif grep -q MODE=objects \$STATE_FILE; then
                echo 'execute(dispatch describe {1})+reload(display_data)'
            else
                echo 'change-prompt(Containers> )+execute-silent(dispatch enter {1})+reload(display_data)+clear-query'
            fi" \
        --bind="ctrl-e:transform:
            if grep -q MODE=pods \$STATE_FILE; then
                echo 'execute(dispatch exec {1})+reload(display_data)'
            elif grep -q MODE=containers \$STATE_FILE; then
                echo 'execute(dispatch exec {1})+reload(display_data)'
            elif grep -q MODE=objects \$STATE_FILE && grep -q RESOURCE=pods \$STATE_FILE; then
                echo 'execute(dispatch exec {1})+reload(display_data)'
            else
                echo 'execute:echo Resource does not support exec'
            fi" \
        --bind="ctrl-d:execute(dispatch describe {1})+reload(display_data)" \
        --bind="ctrl-w:transform:
            if grep -q MODE=objects \$STATE_FILE || grep -q MODE=pods \$STATE_FILE; then
                echo 'execute(dispatch delete {1})+reload(display_data)'
            else
                echo 'execute:echo Delete not available in this view'
            fi" \
        --bind="ctrl-y:execute(dispatch yaml {1})+reload(display_data)" \
        --bind="ctrl-s:transform:
            if grep -q MODE=objects \$STATE_FILE && grep -q -E 'RESOURCE=(deployments|statefulsets|daemonsets|replicasets)' \$STATE_FILE; then
                echo 'execute(dispatch scale {1})+reload(display_data)'
            else
                echo 'change-prompt(Contexts> )+execute-silent(dispatch contexts)+reload(display_data)+clear-query'
            fi" \
        --bind="ctrl-r:change-prompt(Resources> )+execute-silent(dispatch resources)+reload(display_data)+clear-query" \
        --bind="ctrl-v:transform:
            if grep -q MODE=pods \$STATE_FILE; then
                echo 'execute(dispatch logs {1})+reload(display_data)'
            elif grep -q MODE=containers \$STATE_FILE; then
                echo 'execute(dispatch logs {1})+reload(display_data)'
            elif grep -q MODE=objects \$STATE_FILE && grep -q RESOURCE=pods \$STATE_FILE; then
                echo 'execute(dispatch logs {1})+reload(display_data)'
            else
                echo 'execute:echo Logs not available for this resource type'
            fi" \
        --bind="ctrl-b:transform:
            if grep -q MODE=pods \$STATE_FILE; then
                echo 'execute(dispatch debug {1})+reload(display_data)'
            elif grep -q MODE=objects \$STATE_FILE && grep -q RESOURCE=pods \$STATE_FILE; then
                echo 'execute(dispatch debug {1})+reload(display_data)'
            else
                echo 'execute:echo Debug pod creation only available for pods'
            fi" \
        --bind="esc:transform:
            if grep -q MODE=pods \$STATE_FILE; then
                echo abort
            else
                if grep -q MODE=objects \$STATE_FILE; then
                    echo 'change-prompt(Resources> )+execute-silent(dispatch back)+reload(display_data)+clear-query'
                else
                    echo 'change-prompt(Pods> )+execute-silent(dispatch back)+reload(display_data)+clear-query'
                fi
            fi"
fi

